<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IntelliPatrol - Robot Live Map</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- KEYFRAME ANIMATIONS from Analytics page --- */
        @keyframes background-pan {
            0% { transform: scale(1.05) translate(0, 0); }
            50% { transform: 1.15 translate(1%, -1%); }
            100% { transform: scale(1.05) translate(0, 0); }
        }

        /* Register custom property for smooth gradient animation */
        @property --angle {
            syntax: '<angle>';
            initial-value: 0deg;
            inherits: false;
        }

        /* Animation for the RGB border effect */
        @keyframes rgb-border-spin {
            to {
                --angle: 360deg;
            }
        }

        /* Existing fadeIn from previous code */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* New pulse for update text */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Existing blink for emergency robots */
        @keyframes blink {
            50% { opacity: 0; }
        }

        /* --- BASE & BODY STYLES from Analytics page --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #0c1322; /* Dark fallback color */
            color: #e2e8f0;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            /* animation: fadeIn 1s ease-out; This is now handled by page-container */
        }

        /* --- MULTI-LAYERED BACKGROUND from Analytics page --- */
        .background-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            background-image: url('analytics.png');
            background-size: cover;
            background-position: center;
            filter: blur(3px) grayscale(60%) brightness(0.6);
            animation: background-pan 45s ease-in-out infinite;
        }
        .page-container {
            position: relative;
            z-index: 1;
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.8) 0%, rgba(12, 19, 34, 0.9) 60%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            animation: fadeIn 1s ease-out; /* Apply fadeIn here for overall content */
        }

        /* --- NAVIGATION BAR from Analytics page --- */
        #navbar {
            background: rgba(12, 19, 34, 0.6);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            height: 70px;
        }
        .nav-item {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            color: #cbd5e1;
            text-decoration: none;
            font-weight: 500;
            border-radius: 8px;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        .nav-item:hover {
            color: #fff;
            background-color: rgba(45, 212, 191, 0.1);
        }
        .nav-item .icon {
            font-size: 1.2rem;
            color: #2dd4bf;
        }
        .logout-btn {
            margin-left: auto;
        }
        .logout-btn .icon {
            color: #f87171;
        }
        .logout-btn:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }

        /* --- MAIN CONTENT & SECTION STYLES (adapted from Analytics) --- */
        main {
            padding: 4rem 2rem;
            flex-grow: 1;
        }
        .section-title {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 3rem;
            color: #fff;
        }

        /* --- Existing Live Map Specific Styles (adapted for new UI) --- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem; /* Adjusted margin */
            padding: 1.5rem;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        .controls label strong {
            color: #cbd5e1; /* Inherit from analytics theme */
        }
        select {
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: #0c1322;
            color: #e2e8f0;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        select:focus {
            outline: none;
            border-color: #2dd4bf;
            box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.3);
        }
        
        /* Download CSV Button style */
        .download-btn-container {
            text-align: center;
            margin-top: 1rem;
            margin-bottom: 2rem; /* Added margin-bottom for spacing */
        }
        .download-btn {
            padding: 10px 20px;
            font-size: 1rem;
            background: #2dd4bf; /* Teal color from analytics theme */
            color: #0c1322; /* Dark text for contrast */
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0, 255, 213, 0.3);
        }
        .download-btn:hover {
            background-color: #1aae9c;
            transform: translateY(-2px);
        }

        /* Update Info Text */
        .update-info {
            text-align: center;
            margin-top: 1rem;
            margin-bottom: 2rem; /* Added margin to separate from map */
            font-size: 1rem;
            color: #94a3b8; /* A subtle grey from analytics theme */
            animation: pulse 2s infinite ease-in-out;
            font-weight: 500;
        }

        .map-container {
            display: flex;
            justify-content: center;
            margin-top: 0; /* Adjusted, as update-info provides space */
        }

        .map-image {
            width: 95%;
            max-width: 1000px;
            height: auto;
            border-radius: 16px; /* Larger radius for consistency */
            position: relative;
            overflow: hidden; /* Important for border-radius on image */
            
            /* Apply RGB border animation to map container */
            border-width: 2px;
            border-style: solid;
            border-image-slice: 1;
            border-image-source: conic-gradient(from var(--angle), #ff00c8, #7a00ff, #002bff, #00ffd5, #48ff00, #fffb00, #ff7300, #ff0000, #ff00c8);
            animation: rgb-border-spin 4s linear infinite;
            box-shadow: 0 0 20px rgba(0, 255, 213, 0.3); /* Teal glow for map */
        }

        .map-image img {
            width: 100%;
            height: auto;
            border-radius: 14px; /* Slightly smaller to show border */
            display: block; /* Remove extra space below image */
        }

        .robot {
            position: absolute;
            background-color: #2dd4bf; /* Teal from analytics theme */
            color: #0c1322; /* Dark text for contrast */
            font-weight: bold;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 1s ease-in-out;
            z-index: 10;
            transform: translate(-50%, -50%); /* Center the robot on its point */
            box-shadow: 0 0 8px rgba(0, 255, 213, 0.7); /* Glow for robots */
        }

        .robot-label {
            position: absolute;
            color: #facc15; /* Yellow/orange for visibility */
            font-weight: bold;
            font-size: 0.9rem;
            transform: translate(-50%, -150%); /* Position above the robot */
            z-index: 11;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }

        .robot.blink, .robot-label.blink {
            animation: blink 1s step-start 0s infinite;
        }

        /* --- Details Box (adapted from Analytics Card) --- */
        .details-box {
            width: 90%;
            max-width: 1000px;
            background: rgba(30, 41, 59, 0.85); /* Similar to analysis-card background */
            backdrop-filter: blur(10px);
            margin: 2.5rem auto 1.5rem auto; /* Adjusted margins */
            padding: 1.5rem 2rem; /* Consistent padding with analytics card */
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            color: #e2e8f0;
            /* Apply RGB border animation */
            border-width: 2px;
            border-style: solid;
            border-image-slice: 1;
            border-image-source: conic-gradient(from var(--angle), #ff00c8, #7a00ff, #002bff, #00ffd5, #48ff00, #fffb00, #ff7300, #ff0000, #ff00c8);
            animation: rgb-border-spin 4s linear infinite;
        }
        .details-box h2 {
            margin-top: 0;
            margin-bottom: 1.5rem; /* More space for title */
            color: #fff;
            font-size: 1.8rem; /* Larger title */
            text-align: center;
        }

        .robot-detail-card {
            background: rgba(240, 244, 255, 0.05); /* Lighter rgba for cards within details box */
            margin-bottom: 1rem;
            padding: 1rem 1.2rem; /* Slightly more padding */
            border-left: 4px solid #2dd4bf; /* Teal border for card */
            border-radius: 8px; /* Slightly larger radius */
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        .robot-detail-card:hover {
             transform: translateX(5px);
             background-color: rgba(240, 244, 255, 0.1);
        }
        .robot-detail-card p {
            margin: 0.4rem 0;
            color: #cbd5e1;
            line-height: 1.5;
        }
        .robot-detail-card p strong {
            color: #94a3b8; /* Consistent strong tag color */
        }

        /* --- Notifications Box (adapted from Analytics Card) --- */
        .notifications-box {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px; /* Slightly wider */
            z-index: 999;
            background: rgba(30, 41, 59, 0.9); /* Darker background for notifications */
            backdrop-filter: blur(12px); /* Stronger blur */
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.4); /* Red glow for notifications */
            display: none;
            /* Apply RGB border animation */
            border-width: 2px;
            border-style: solid;
            border-image-slice: 1;
            border-image-source: conic-gradient(from var(--angle), #ff00c8, #7a00ff, #002bff, #00ffd5, #48ff00, #fffb00, #ff7300, #ff0000, #ff00c8);
            animation: rgb-border-spin 4s linear infinite;
        }
        .notifications-box h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            color: #fff;
            font-size: 1.8rem;
            text-align: center;
        }

        .notification-item {
            background: rgba(239, 68, 68, 0.15); /* Red tinted background */
            color: #f87171; /* Red text */
            padding: 0.75rem 1rem; /* More padding */
            margin-bottom: 0.8rem; /* More margin */
            border-left: 4px solid #dc2626; /* Stronger red border */
            border-radius: 8px;
            font-weight: 600; /* Bolder text */
            animation: fadeIn 0.5s ease-out;
            transition: transform 0.2s ease;
        }
        .notification-item:hover {
            transform: translateX(-3px);
        }

        /* --- FOOTER from Analytics page --- */
        footer {
            background: transparent;
            color: #64748b;
            text-align: center;
            padding: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto; /* Push footer to bottom */
        }
    </style>
    <link rel="stylesheet" href="responsive.css" />
</head>
<body>

<div class="background-container"></div>
<div class="page-container">
    <nav id="navbar"></nav>

    <main>
        <h2 class="section-title">üó∫Ô∏è Robot Live Map</h2>

        <div class="controls">
            <label for="regionSelect"><strong>Select Region:</strong></label>
            <select id="regionSelect" onchange="switchRegion()">
                <option value="A">Region A</option>
                <option value="B">Region B</option>
                <option value="C">Region C</option>
            </select>
        </div>

        <div class="download-btn-container">
            <button onclick="downloadCSV()" class="download-btn">
                ‚¨áÔ∏è Download Sensor Data CSV
            </button>
        </div>

        <div class="update-info" id="updateInfo">Robot location updates every 10 seconds</div>

        <div class="map-container">
            <div class="map-image" id="map">
                <img src="map.png" alt="Warehouse Map" id="mapImage">
            </div>
        </div>

        <div class="details-box" id="robotDetails">
            <h2>ü§ñ Robot Details</h2>
        </div>

        <div class="notifications-box" id="notifications">
            <h2>üîî Notifications</h2>
        </div>
    </main>

    <footer>
        &copy; 2025 IntelliPatrol - A  Digital Engineering Initiative
    </footer>
</div>

<script>
    // --- USER AUTHENTICATION & DYNAMIC NAVIGATION (from Analytics page) ---
    const role = localStorage.getItem("role");

    if (!role) {
        window.location.href = "login.html";
    }

    const navbar = document.getElementById("navbar");
    let links = `<a href="home.html" class="nav-item"><span class="icon">üè†</span><span>Home</span></a>`;

    const navConfig = {
        admin: [
             { href: 'index.html', icon: 'üì•', text: 'Input' },
            { href: 'dashboard.html', icon: 'üìä', text: 'Dashboard' },
            { href: 'simulation.html', icon: '‚öôÔ∏è', text: 'Simulation' },
            { href: 'analytics.html', icon: 'üìà', text: 'Analytics' },
            { href: 'robot-map.html', icon: 'üó∫Ô∏è', text: 'Robot Map' },
             { href: 'admin_approval.html', icon: '‚úÖ', text: 'Approvals' },
              { href: 'about.html', icon: '‚ÑπÔ∏è', text: 'About' },
            { href: 'contact.html', icon: 'üìû', text: 'Contact Us' },
            { href: 'admin.html', icon: 'üë§', text: 'My Profile' }
        ],
        user: [
            { href: 'index.html', icon: 'üì•', text: 'Input' },
            { href: 'dashboard.html', icon: 'üìä', text: 'Dashboard' },
            { href: 'robot-map.html', icon: 'üó∫Ô∏è', text: 'Robot Map' }, // Changed text to Live Map
             { href: 'about.html', icon: '‚ÑπÔ∏è', text: 'About' },
            { href: 'contact.html', icon: 'üìû', text: 'Contact Us' },
            { href: 'user_profile.html', icon: 'üë§', text: 'My Profile' }
        ],
        customer: [
            { href: 'dashboard.html', icon: 'üìä', text: 'Dashboard' },
            { href: 'simulation.html', icon: '‚öôÔ∏è', text: 'Simulation' },
            { href: 'robot-map.html', icon: 'üó∫Ô∏è', text: 'Robot Map' }, // Changed text to Live Map
             { href: 'about.html', icon: '‚ÑπÔ∏è', text: 'About' },
            { href: 'contact.html', icon: 'üìû', text: 'Contact Us' },
            { href: 'customer_profile.html', icon: 'üë§', text: 'My Profile' }
        ],
        stakeholder: [
            { href: 'dashboard.html', icon: 'üìä', text: 'Dashboard' },
            { href: 'analytics.html', icon: 'üìà', text: 'Analytics' },
            { href: 'robot-map.html', icon: 'üó∫Ô∏è', text: 'Robot Map' }, // Changed text to Live Map
             { href: 'about.html', icon: '‚ÑπÔ∏è', text: 'About' },
            { href: 'contact.html', icon: 'üìû', text: 'Contact Us' },
            { href: 'stakeholder_profile.html', icon: 'üë§', text: 'My Profile' }
        ]
    };
    
    if (navConfig[role]) {
        navConfig[role].forEach(link => {
            links += `<a href="${link.href}" class="nav-item"><span class="icon">${link.icon}</span><span>${link.text}</span></a>`;
        });
    }

    links += `<a href="#" onclick="logout()" class="nav-item logout-btn"><span class="icon">üö™</span><span>Logout</span></a>`;
    navbar.innerHTML = links;

    function logout() {
        localStorage.clear();
        window.location.href = "login.html";
    }

    // --- ROBOT LIVE MAP LOGIC (from previous robot-map.html) ---
    const lambdaURL = "https://fdmrsf4fnvkrrgvzs4mtmwwx3m0uawtk.lambda-url.us-east-1.on.aws/";

    // IMPORTANT: Base dimensions of your 'robot map.jpg' image
    // You'll need to verify these if your image size is different.
    const baseMapWidth = 998; // Width of the robot map.jpg image
    const baseMapHeight = 636; // Height of the robot map.jpg image

    // Define the paths based on the 'robot map.jpg' image you provided.
    const paths = {
        A: [
            // Robot 1 (Path P1 - Left side, looping through pallets and office)
            [{x: 102, y: 153}, {x: 102, y: 396}, {x: 326, y: 396}, {x: 326, y: 508}, {x: 432, y: 508}, {x: 432, y: 450}, {x: 432, y: 396}, {x: 432, y: 153}, {x: 102, y: 153}],
            // Robot 2 (Path P2 - Top right, looping through pallets)
            [{x: 550, y: 153}, {x: 870, y: 153}, {x: 870, y: 396}, {x: 550, y: 396}, {x: 550, y: 153}],
            // Robot 3 (Path P3 - Bottom right, looping around shipping station and package carts)
            [{x: 550, y: 450}, {x: 870, y: 450}, {x: 870, y: 550}, {x: 750, y: 550}, {x: 750, y: 450}, {x: 550, y: 450}]
        ],
        B: [
            // Slightly shifted paths for Region B (example, adjust as needed)
            [{x: 122, y: 173}, {x: 122, y: 416}, {x: 346, y: 416}, {x: 346, y: 528}, {x: 452, y: 528}, {x: 452, y: 470}, {x: 452, y: 416}, {x: 452, y: 173}, {x: 122, y: 173}],
            [{x: 570, y: 173}, {x: 890, y: 173}, {x: 890, y: 416}, {x: 570, y: 416}, {x: 570, y: 173}],
            [{x: 570, y: 470}, {x: 890, y: 470}, {x: 890, y: 570}, {x: 770, y: 570}, {x: 770, y: 470}, {x: 570, y: 470}]
        ],
        C: [
            // Slightly shifted paths for Region C (example, adjust as needed)
            [{x: 142, y: 193}, {x: 142, y: 436}, {x: 366, y: 436}, {x: 366, y: 548}, {x: 472, y: 548}, {x: 472, y: 490}, {x: 472, y: 436}, {x: 472, y: 193}, {x: 142, y: 193}],
            [{x: 590, y: 193}, {x: 910, y: 193}, {x: 910, y: 436}, {x: 590, y: 436}, {x: 590, y: 193}],
            [{x: 590, y: 490}, {x: 910, y: 490}, {x: 910, y: 590}, {x: 790, y: 590}, {x: 790, y: 490}, {x: 590, y: 490}]
        ]
    };

    const robots = {
        A: ["A1", "A2", "A3"],
        B: ["B1", "B2", "B3"],
        C: ["C1", "C2", "C3"]
    };

    const robotMap = {
        A1: "R1", A2: "R2", A3: "R3",
        B1: "R4", B2: "R5", B3: "R6",
        C1: "R7", C2: "R8", C3: "R9"
    };

    let state = {
        currentRegion: "A",
        steps: [0, 0, 0],
        pause: [false, false, false],
        status: {}
    };

    function switchRegion() {
        state.currentRegion = document.getElementById("regionSelect").value;
        state.steps = [0, 0, 0];
        state.pause = [false, false, false];
        renderAll();
    }

    async function fetchRobotData() {
        try {
            const res = await fetch(lambdaURL);
            const data = await res.json();
            const all = {};
            data.forEach(item => {
                all[item.robot_id] = {
                    status: item.status,
                    temperature: item.temperature,
                    humidity: item.humidity,
                    gas_leak: item.gas_leak,
                    fire_incident: item.fire_incident,
                    location: item.location,
                    message: item.message,
                    timestamp: item.timestamp
                };
            });

            Object.keys(robotMap).forEach(id => {
                const robotId = robotMap[id];
                if (all[robotId]) {
                    const real = all[robotId];
                    if (real.status !== "Emergency") {
                        const simulatedStatus = ["Normal", "Alert", "Emergency"][Math.floor(Math.random() * 3)];
                        real.status = simulatedStatus;
                        real.temperature = (34 + Math.random() * 5).toFixed(1);
                        real.humidity = (60 + Math.random() * 15).toFixed(0);
                        if (simulatedStatus === "Emergency") {
                            real.fire_incident = Math.random() > 0.5 ? "yes" : "no";
                            real.gas_leak = Math.random() > 0.5 ? "yes" : "no";
                            real.message = "üö® Emergency triggered by sensors!";
                        } else {
                            real.fire_incident = "no";
                            real.gas_leak = "no";
                            real.message = simulatedStatus === "Alert" ? "‚ö†Ô∏è Suspicious movement detected." : "üü¢ All clear.";
                        }
                        const now = new Date();
                        real.timestamp = now.toISOString().replace("T", " ").substring(0, 19);
                    }
                    state.status[id] = real;
                }
            });

            renderAll();
        } catch (err) {
            console.error("Fetch error:", err);
        }
    }

    function getAction(status, fire, gas) {
        if (status === "Emergency") {
            const p = [];
            if (fire === "yes") p.push("üî• Fire");
            if (gas === "yes") p.push("üí® Gas Leak");
            return `üö® Emergency! Problem: ${p.join(", ")}`;
        }
        if (status === "Alert") return "‚ö†Ô∏è Scanning suspicious zone.";
        return "üü¢ Patrolling normally.";
    }

    function renderAll() {
        const mapDiv = document.getElementById("map");
        const mapImage = document.getElementById("mapImage");
        
        // Get the *actual rendered dimensions* of the map image.
        const currentMapWidth = mapImage.offsetWidth;
        const currentMapHeight = mapImage.offsetHeight;

        document.querySelectorAll(".robot, .robot-label").forEach(e => e.remove());
        const detailsBox = document.getElementById("robotDetails");
        const notifyBox = document.getElementById("notifications");
        detailsBox.innerHTML = `<h2>ü§ñ Robot Details</h2>`;
        notifyBox.innerHTML = `<h2>üîî Notifications</h2>`;
        
        let hasEmergencyNotifications = false;

        robots[state.currentRegion].forEach((id, i) => {
            const status = state.status[id];
            if (!status) return;
            const path = paths[state.currentRegion][i];
            const step = state.steps[i] % path.length;
            const point = path[step];

            const robot = document.createElement("div");
            const emergency = status.status === "Emergency";
            robot.className = "robot" + (emergency ? " blink" : "");
            robot.style.backgroundColor = emergency ? "#f87171" : "#2dd4bf"; // Use analytics theme colors for robot status
            robot.textContent = id.substring(1); // Display only number (e.g., '1' for 'A1')
            
            // Calculate position based on the ratio of path coordinates to base map size,
            // then apply that ratio to the *current rendered map size*.
            robot.style.left = `${(point.x / baseMapWidth) * currentMapWidth}px`;
            robot.style.top = `${(point.y / baseMapHeight) * currentMapHeight}px`;
            
            robot.title = `${id} - ${status.status}`;
            robot.onclick = () => {
                alert(`${id} - ${status.location}\n${getAction(status.status, status.fire_incident, status.gas_leak)}`);
            };
            mapDiv.appendChild(robot);

            const label = document.createElement("div");
            label.className = "robot-label" + (emergency ? " blink" : "");
            label.innerText = emergency ? `${id} üö® Emergency` : id;
            
            // Position label relative to the robot's calculated position
            label.style.left = `${(point.x / baseMapWidth) * currentMapWidth}px`;
            label.style.top = `${(point.y / baseMapHeight) * currentMapHeight}px`;
            mapDiv.appendChild(label);

            const card = document.createElement("div");
            card.className = "robot-detail-card";
            card.innerHTML = `
                <p><strong>${id}</strong></p>
                <p>Status: ${status.status}</p>
                <p>Temp: ${status.temperature}¬∞C | Humidity: ${status.humidity}%</p>
                <p>Location: ${status.location}</p>
                <p>Action: ${getAction(status.status, status.fire_incident, status.gas_leak)}</p>
                <p><small>${status.timestamp}</small></p>
            `;
            detailsBox.appendChild(card);

            if (emergency) {
                const existingNote = document.getElementById(`note-${id}`);
                if (!existingNote) {
                    const note = document.createElement("div");
                    note.id = `note-${id}`;
                    note.className = "notification-item";
                    note.innerText = `üö® ${id} reported Emergency at ${status.location}`;
                    notifyBox.appendChild(note);
                }
                hasEmergencyNotifications = true;
                state.pause[i] = true;

                setTimeout(() => {
                    const currentNote = document.getElementById(`note-${id}`);
                    if (currentNote) currentNote.remove();
                    const remainingEmergencyNotes = notifyBox.querySelectorAll('.notification-item').length;
                    if (remainingEmergencyNotes === 0) {
                        notifyBox.style.display = "none";
                    }
                    state.pause[i] = false;
                }, 6000);
            }
        });

        if (hasEmergencyNotifications) {
            notifyBox.style.display = "block";
        } else {
            notifyBox.style.display = "none";
        }
    }

    window.onload = () => {
        fetchRobotData();
    };

    setInterval(() => {
        state.steps = state.steps.map((step, i) => state.pause[i] ? step : step + 1);
        fetchRobotData();
    }, 10000);

    async function downloadCSV() {
        try {
            const res = await fetch(lambdaURL + "/all");
            const data = await res.json();
            let csv = "Sensor ID,Temperature,Humidity,Gas,Fire,Status,Region,Timestamp\n";
            data.forEach(item => {
                csv += `${item.sensor_id || item.robot_id},${item.temperature},${item.humidity},${item.gas_leak},${item.fire_incident},${item.status},${item.region},${item.timestamp}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv" });
            const link = document.createElement("a");
            link.href = window.URL.createObjectURL(blob);
            link.download = "sensor_data.csv";
            link.click();
        } catch (error) {
            alert("‚ùå Failed to download CSV.");
            console.error(error);
        }
    }
</script>

</body>
</html>